name: user-server-integrated

on:
  workflow_run:
    workflows: ["user-server-build", "user-server-test", "user-server-quality-gate"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  wait-and-verify:
    name: Verify All Pipelines Succeeded
    runs-on: ubuntu-latest
    steps:
      - name: Check all workflow runs (Build, Test, Quality Gate)
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const requiredWorkflows = ['user-server-build', 'user-server-test', 'user-server-quality-gate'];
            let failures = [];
            
            const runs = await github.rest.actions.listWorkflowRunsForRepo({ 
              owner, 
              repo, 
              per_page: 100 
            });
            
            for (const wfName of requiredWorkflows) {
              const run = runs.data.workflow_runs.find(r => r.name === wfName);
            
              if (!run) {
                failures.push(`${wfName}: no recent run found`);
                continue;
              }
            
              if (run.status !== 'completed') {
                failures.push(`${wfName}: still running (status=${run.status})`);
                continue;
              }
            
              if (run.conclusion !== 'success') {
                failures.push(`${wfName}: failed (conclusion=${run.conclusion})`);
                continue;
              }
            
              console.log(`✓ ${wfName}: SUCCESS`);
            }
            
            if (failures.length > 0) {
              console.error('❌ Pipeline verification failed:');
              failures.forEach(f => console.error(`  - ${f}`));
              throw new Error('Integrated check failed: ' + failures.join('; '));
            }
            
            console.log('✓ All required pipelines (build, test, quality-gate) completed successfully!');

