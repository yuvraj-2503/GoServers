name: user-server-integrated

on:
  workflow_run:
    workflows: ["user-server-build", "user-server-test", "user-server-quality-gate"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  wait-and-verify:
    name: Verify All Pipelines Succeeded
    runs-on: ubuntu-latest
    steps:
      - name: Check all workflow runs (Build, Test, Quality Gate)
        uses: actions/github-script@v6
        with:
          script: |
            // Ensure we only consider runs for the same commit (head_sha) to avoid races
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const requiredWorkflows = ['user-server-build', 'user-server-test', 'user-server-quality-gate'];
            const headSha = context.payload && context.payload.workflow_run && context.payload.workflow_run.head_sha ? context.payload.workflow_run.head_sha : process.env.GITHUB_SHA;
            let failures = [];

            // Helper: sleep
            const sleep = (ms) => new Promise((res) => setTimeout(res, ms));

            for (const wfName of requiredWorkflows) {
              let foundAndChecked = false;
              // retry loop: wait up to ~60s total (12 * 5s) for other workflows to appear/complete
              for (let attempt = 0; attempt < 12; attempt++) {
                const runs = await github.rest.actions.listWorkflowRunsForRepo({ owner, repo, per_page: 100 });
                const run = runs.data.workflow_runs.find(r => r.name === wfName && r.head_sha === headSha);

                if (!run) {
                  console.log(`${wfName}: no run found for head ${headSha} (attempt ${attempt + 1}/12)`);
                  await sleep(5000);
                  continue;
                }

                if (run.status !== 'completed') {
                  console.log(`${wfName}: run found but status=${run.status} (attempt ${attempt + 1}/12), waiting`);
                  await sleep(5000);
                  continue;
                }

                if (run.conclusion !== 'success') {
                  failures.push(`${wfName}: failed (conclusion=${run.conclusion})`);
                } else {
                  console.log(`✓ ${wfName}: SUCCESS (head ${headSha})`);
                }

                foundAndChecked = true;
                break;
              }

              if (!foundAndChecked) {
                failures.push(`${wfName}: no completed run found for head ${headSha} after retries`);
              }
            }

            if (failures.length > 0) {
              console.error('❌ Pipeline verification failed:');
              failures.forEach(f => console.error(`  - ${f}`));
              throw new Error('Integrated check failed: ' + failures.join('; '));
            }

            console.log('✓ All required pipelines (build, test, quality-gate) completed successfully for head ' + headSha + '!');

